
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Linux TCP套接字地址复用 · GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="Linux TCP套接字地址复用。">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../Other/" />
    
    
    <link rel="prev" href="ssh-key-copy.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    简介
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../">
            
                <a href="../">
            
                    
                    Java
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../Java/ScheduleTaskExample.html">
            
                <a href="../Java/ScheduleTaskExample.html">
            
                    
                    Schedule定时任务示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../Java/ExpiringMapExample.html">
            
                <a href="../Java/ExpiringMapExample.html">
            
                    
                    ExpiringMap示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../Java/ThreadPoolTaskExecutorExample1.html">
            
                <a href="../Java/ThreadPoolTaskExecutorExample1.html">
            
                    
                    ThreadPoolTaskExecutor使用示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../Java/ThreadPoolTaskExecutorExample2.html">
            
                <a href="../Java/ThreadPoolTaskExecutorExample2.html">
            
                    
                    ThreadPoolTaskExecutor-Async使用示例
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../C++/">
            
                <a href="../C++/">
            
                    
                    C++
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../C++/Cpp11-Demo.html">
            
                <a href="../C++/Cpp11-Demo.html">
            
                    
                    C++11 示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../C++/WinCppPowerOnAutoStart.html">
            
                <a href="../C++/WinCppPowerOnAutoStart.html">
            
                    
                    Windows程序开机自启
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../C++/CppNewArrayInit.html">
            
                <a href="../C++/CppNewArrayInit.html">
            
                    
                    new内存初始化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../C++/libcurl-down-file.html">
            
                <a href="../C++/libcurl-down-file.html">
            
                    
                    利用libcurl下载文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../C++/librdkafka-example.html">
            
                <a href="../C++/librdkafka-example.html">
            
                    
                    librdkafka示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../C++/ParseTLV.html">
            
                <a href="../C++/ParseTLV.html">
            
                    
                    TLV数据格式解析示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.7" data-path="../C++/RabbitMQ-example.html">
            
                <a href="../C++/RabbitMQ-example.html">
            
                    
                    RabbitMQ示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.8" data-path="../C++/SingletonTemplate.html">
            
                <a href="../C++/SingletonTemplate.html">
            
                    
                    单实例模板
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.9" data-path="../C++/socket-bind-iface.html">
            
                <a href="../C++/socket-bind-iface.html">
            
                    
                    Socket绑定网络接口
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.10" data-path="../C++/spdlog-examples.html">
            
                <a href="../C++/spdlog-examples.html">
            
                    
                    Spdlog示例
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../Qt5/">
            
                <a href="../Qt5/">
            
                    
                    Qt5
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../Qt5/GridLayout.html">
            
                <a href="../Qt5/GridLayout.html">
            
                    
                    网格示例
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="./">
            
                <a href="./">
            
                    
                    Linux
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="CMakeListTemplate.html">
            
                <a href="CMakeListTemplate.html">
            
                    
                    CMakeLists基础通用模板
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="LibraryRpath.html">
            
                <a href="LibraryRpath.html">
            
                    
                    动态库加载路径设置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="ssh-key-copy.html">
            
                <a href="ssh-key-copy.html">
            
                    
                    SSH免密登录
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.4" data-path="tcpsock-reuseport.html">
            
                <a href="tcpsock-reuseport.html">
            
                    
                    Linux TCP套接字地址复用
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../Other/">
            
                <a href="../Other/">
            
                    
                    Other
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../Other/GuoHomeLetter.html">
            
                <a href="../Other/GuoHomeLetter.html">
            
                    
                    郭德纲家书
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../Other/ChickenSoup.html">
            
                <a href="../Other/ChickenSoup.html">
            
                    
                    毒鸡汤
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../Other/Tiandao-Wu.html">
            
                <a href="../Other/Tiandao-Wu.html">
            
                    
                    天道·悟
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../Other/tools-collection.html">
            
                <a href="../Other/tools-collection.html">
            
                    
                    实用小工具
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.5" data-path="../Other/MyPicture.html">
            
                <a href="../Other/MyPicture.html">
            
                    
                    图片
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Linux TCP套接字地址复用</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="1-&#x6982;&#x8FF0;">1. &#x6982;&#x8FF0;</h2>
<p><strong><em>github&#x9879;&#x76EE;&#x5730;&#x5740;&#xFF1A;<a href="https://github.com/superwujc" target="_blank">https://github.com/superwujc</a>
&#x5C0A;&#x91CD;&#x539F;&#x521B;&#xFF0C;&#x6B22;&#x8FCE;&#x8F6C;&#x8F7D;&#xFF0C;&#x6CE8;&#x660E;&#x51FA;&#x5904;&#xFF1A;<a href="https://my.oschina.net/superwjc/blog/1824089" target="_blank">https://my.oschina.net/superwjc/blog/1824089</a></em></strong></p>
<p>&#x5BF9;&#x4E8E;&#x7279;&#x5B9A;&#x7684;&#x4F20;&#x8F93;&#x5C42;&#x534F;&#x8BAE;&#xFF08;&#x5305;&#x62EC;TCP&#xFF09;&#xFF0C;&#x6BCF;&#x4E2A;&#x5957;&#x63A5;&#x5B57;&#x901A;&#x8FC7;4&#x5143;&#x7EC4;{ &#x672C;&#x7AEF;ip, &#x672C;&#x7AEF;port, &#x5BF9;&#x7AEF;ip, &#x5BF9;&#x7AEF;port }&#x8FDB;&#x884C;&#x552F;&#x4E00;&#x6807;&#x8BC6;&#xFF0C;&#x8BE5;4&#x5143;&#x7EC4;&#x53E6;&#x53EF;&#x5212;&#x5206;&#x4E3A;&#x4E00;&#x4E2A;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x5BF9;(socket pair)&#xFF1A;&#x672C;&#x7AEF;ip&#x4E0E;&#x672C;&#x7AEF;port&#x7EC4;&#x6210;&#x672C;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#xFF0C;&#x5BF9;&#x7AEF;ip&#x4E0E;&#x5BF9;&#x7AEF;port&#x7EC4;&#x6210;&#x5BF9;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x3002;</p>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5185;&#x6838;&#x4EC5;&#x5141;&#x8BB8;&#x5BF9;&#x4E0D;&#x540C;&#x7684;&#x672C;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x8C03;&#x7528;bind(2)&#xFF0C;&#x4F46;&#x4E0D;&#x5141;&#x8BB8;&#x76F8;&#x540C;&#x7684;&#x672C;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x590D;&#x7528;&#xFF0C;&#x5BF9;&#x5DF2;&#x5B58;&#x5728;&#x7684;&#x672C;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x518D;&#x6B21;&#x6267;&#x884C;bind(2)&#x65F6;&#xFF0C;&#x5C06;&#x4EE5;EADDRINUSE&#x9519;&#x8BEF;&#x5931;&#x8D25;&#xFF0C;&#x5373;&#x5730;&#x5740;&#x5DF2;&#x88AB;&#x5360;&#x7528;&#xFF1B;Linux&#x5185;&#x6838;&#x6839;&#x636E;&#x4E0D;&#x540C;&#x7684;&#x5E94;&#x7528;&#x573A;&#x666F;&#xFF0C;&#x8BBE;&#x7F6E;&#x4E86;&#x82E5;&#x5E72;&#x79CD;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x590D;&#x7528;&#x7684;&#x6761;&#x4EF6;&#xFF0C;&#x5305;&#x62EC;&#x5957;&#x63A5;&#x5B57;&#x9009;&#x9879;SO_REUSEADDR&#xFF0C;SO_REUSEPORT&#x4E0E;SO_BINDTODEVICE&#x3002;</p>
<h2 id="2-&#x5E94;&#x7528;&#x573A;&#x666F;">2. &#x5E94;&#x7528;&#x573A;&#x666F;</h2>
<p>Linux&#x5185;&#x6838;&#x6839;&#x636E;&#x4EE5;&#x4E0B;&#x987A;&#x5E8F;&#x5224;&#x65AD;&#x672C;&#x7AEF;ipv4&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#xFF1A;</p>
<ul>
<li>&#x539F;&#x5957;&#x63A5;&#x5B57;&#x4E0E;&#x65B0;&#x5957;&#x63A5;&#x5B57;&#x90FD;&#x5F00;&#x542F;&#x4E86;SO_REUSEPORT&#x9009;&#x9879;&#xFF0C;&#x4E14;&#x521B;&#x5EFA;&#x539F;&#x5957;&#x63A5;&#x5B57;&#x4E0E;&#x65B0;&#x5957;&#x63A5;&#x5B57;&#x7684;&#x8FDB;&#x7A0B;EUID&#x76F8;&#x540C;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#x672C;&#x7AEF;ip&#x4E0E;&#x672C;&#x7AEF;port&#xFF1B;&#x6216;</li>
<li>&#x539F;&#x5957;&#x63A5;&#x5B57;&#x4E0E;&#x65B0;&#x5957;&#x63A5;&#x5B57;&#x90FD;&#x901A;&#x8FC7;SO_BINDTODEVICE&#x9009;&#x9879;&#x7ED1;&#x5B9A;&#x81F3;&#x4E0D;&#x540C;&#x7684;&#x7F51;&#x7EDC;&#x63A5;&#x53E3;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#x672C;&#x7AEF;ip&#x4E0E;&#x672C;&#x7AEF;port&#xFF1B;&#x6216;</li>
<li>&#x539F;&#x5957;&#x63A5;&#x5B57;&#x4E0E;&#x65B0;&#x5957;&#x63A5;&#x5B57;&#x90FD;&#x5F00;&#x542F;&#x4E86;SO_REUSEADDR&#x9009;&#x9879;&#xFF0C;&#x4E14;&#x5957;&#x63A5;&#x5B57;&#x72B6;&#x6001;&#x90FD;&#x4E0D;&#x4E3A;LISTEN&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#x672C;&#x7AEF;ip&#x4E0E;&#x672C;&#x7AEF;port&#xFF1B;&#x6216;</li>
<li>&#x539F;&#x5957;&#x63A5;&#x5B57;&#x4E0E;&#x65B0;&#x5957;&#x63A5;&#x5B57;&#x7ED1;&#x5B9A;&#x81F3;&#x4E0D;&#x540C;&#x7684;&#x672C;&#x7AEF;ip&#x5730;&#x5740;&#xFF0C;&#x4E14;&#x90FD;&#x4E0D;&#x4E3A;&#x901A;&#x914D;&#x5730;&#x5740;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#x672C;&#x7AEF;port</li>
</ul>
<h2 id="21---soreuseport">2.1 - SO_REUSEPORT</h2>
<p>SO_REUSEPORT&#x662F;&#x81EA;3.9&#x5185;&#x6838;&#x5F00;&#x59CB;&#x652F;&#x6301;&#x7684;&#x5957;&#x63A5;&#x5B57;&#x9009;&#x9879;&#xFF0C;&#x8BE5;&#x9009;&#x9879;&#x7528;&#x4E8E;&#x540C;&#x65F6;&#x8FD0;&#x884C;&#x540C;&#x4E00;&#x672C;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x7684;&#x591A;&#x4E2A;&#x5B9E;&#x4F8B;&#xFF0C;&#x901A;&#x8FC7;&#x5C06;&#x4F20;&#x5165;&#x7684;&#x8BF7;&#x6C42;&#x5206;&#x53D1;&#x81F3;&#x4E0D;&#x540C;&#x7684;&#x63A5;&#x6536;&#x7AEF;&#x8FDB;&#x7A0B;&#x6216;&#x7EBF;&#x7A0B;&#x800C;&#x5B9E;&#x73B0;&#x5957;&#x63A5;&#x5B57;&#x5C42;&#x9762;&#x7684;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#xFF0C;&#x63D0;&#x5347;&#x8FD0;&#x884C;&#x5728;&#x591A;&#x6838;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0A;&#x7684;&#x591A;&#x7EBF;&#x7A0B;&#x7F51;&#x7EDC;&#x670D;&#x52A1;&#x5668;&#x6027;&#x80FD;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;TCP&#xFF0C;&#x8BE5;&#x9009;&#x9879;&#x7684;&#x5F00;&#x542F;&#x65B9;&#x5F0F;&#x4E3A;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-keyword">int</span> sfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-keyword">int</span> optval = <span class="hljs-number">1</span>;
setsockopt(sfd, SOL_SOCKET, SO_REUSEPORT, &amp;optval, <span class="hljs-keyword">sizeof</span>(optval));

bind(sfd, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;addr, addrlen);
</code></pre>
<p>&#x82E5;&#x9700;&#x4F7F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x5219;&#x6BCF;&#x4E00;&#x4E2A;&#x5957;&#x63A5;&#x5B57;&#xFF08;&#x5305;&#x62EC;&#x7B2C;1&#x4E2A;&#xFF09;&#x5728;&#x6267;&#x884C;bind(2)&#x524D;&#x90FD;&#x5FC5;&#x987B;&#x5F00;&#x542F;&#x8BE5;&#x9009;&#x9879;&#xFF0C;&#x4E14;&#x521B;&#x5EFA;&#x5957;&#x63A5;&#x5B57;&#x7684;&#x8FDB;&#x7A0B;EUID&#x5FC5;&#x987B;&#x76F8;&#x540C;&#x3002;</p>
<p>Linux &#x5185;&#x6838;&#x5F53;&#x524D;&#x7684;TCP&#x534F;&#x8BAE;&#x5B9E;&#x73B0;&#x5BF9;&#x8BE5;&#x9009;&#x9879;&#x7684;&#x652F;&#x6301;&#x5B58;&#x5728;&#x7F3A;&#x9677;&#xFF1A;&#x8FD0;&#x884C;&#x540C;&#x4E00;&#x670D;&#x52A1;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x7684;&#x5B9E;&#x4F8B;&#x6570;&#x91CF;&#x589E;&#x52A0;&#x6216;&#x51CF;&#x5C11;&#x65F6;&#xFF0C;&#x7531;&#x4E8E;&#x4E09;&#x6B21;&#x63E1;&#x624B;&#x8FC7;&#x7A0B;&#x4E2D;&#x7684;&#x521D;&#x59CB;SYN&#x5305;&#x4E0E;&#x67D0;&#x4E2A;&#x7279;&#x5B9A;&#x7684;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x76F8;&#x5173;&#x8054;&#xFF0C;SO_REUSEPORT&#x53EF;&#x80FD;&#x4E0D;&#x4F1A;&#x5C06;ACK&#x53D1;&#x9001;&#x81F3;&#x6B63;&#x786E;&#x7684;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#xFF0C;&#x5BFC;&#x81F4;&#x5BA2;&#x6237;&#x7AEF;&#x88AB;RESET&#xFF0C;&#x800C;&#x670D;&#x52A1;&#x7AEF;&#x7EE7;&#x7EED;&#x7EF4;&#x6301;&#x672A;&#x5B8C;&#x6210;&#x7684;&#x8FDE;&#x63A5;&#xFF1B;&#x540E;&#x7EED;&#x7684;&#x5185;&#x6838;&#x7248;&#x672C;&#x53EF;&#x80FD;&#x5F15;&#x5165;&#x4E00;&#x4E2A;&#x5171;&#x4EAB;&#x4E8E;&#x76D1;&#x542C;&#x5957;&#x63A5;&#x5B57;&#x4E4B;&#x95F4;&#x7684;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;&#x8868;&#x4EE5;&#x89E3;&#x51B3;&#x8BE5;&#x95EE;&#x9898;&#x3002;</p>
<h2 id="22---sobindtodevice">2.2 - SO_BINDTODEVICE</h2>
<p>&#x8BE5;&#x9009;&#x9879;&#x5C06;&#x5957;&#x63A5;&#x5B57;&#x7ED1;&#x5B9A;&#x81F3;&#x7279;&#x5B9A;&#x7684;&#x7F51;&#x7EDC;&#x63A5;&#x53E3;&#xFF0C;&#x5982;eth0&#xFF0C;&#x4F7F;&#x5F97;&#x4EC5;&#x4ECE;&#x8BE5;&#x7F51;&#x7EDC;&#x63A5;&#x53E3;&#x63A5;&#x6536;&#x5230;&#x7684;&#x6570;&#x636E;&#x5305;&#x624D;&#x4F1A;&#x88AB;&#x8BE5;&#x5957;&#x63A5;&#x5B57;&#x5904;&#x7406;&#x3002;</p>
<p>&#x8C03;&#x7528;setsockopt(2)&#x8BBE;&#x7F6E;&#x8BE5;&#x9009;&#x9879;&#x65F6;&#xFF0C;optval&#x4E0E;optlen&#x53C2;&#x6570;&#x5206;&#x522B;&#x4E3A;&#x7F51;&#x7EDC;&#x63A5;&#x53E3;&#x540D;&#x79F0;&#x5B57;&#x7B26;&#x4E32;&#x4E0E;&#x957F;&#x5EA6;&#xFF0C;&#x8C03;&#x7528;&#x65B9;&#x5F0F;&#x4E3A;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-keyword">char</span> *dev = DEVNAME;
len = <span class="hljs-built_in">strlen</span>(dev);
setsockopt(sock, SOL_SOCKET, SO_BINDTODEVICE, dev, len);
</code></pre>
<blockquote>
<font color="red">&#x6279;&#x6CE8;&#xFF1A;&#x539F;&#x4F5C;&#x8005;&#x8FD9;&#x91CC;&#x53D6;&#x7F51;&#x5361;&#x63A5;&#x53E3;&#x540D;&#x7684;&#x957F;&#x5EA6;&#x9519;&#x8BEF;&#x3002;</font>

</blockquote>
<p>&#x7F51;&#x7EDC;&#x63A5;&#x53E3;&#x540D;&#x79F0;&#x5B57;&#x7B26;&#x4E32;&#x7684;&#x6700;&#x5927;&#x957F;&#x5EA6;&#x4E3A;IFNAMSIZ(16)&#x5B57;&#x8282;&#xFF0C;&#x4EE5;&#x7A7A;&#x5B57;&#x8282;(&apos;\0&apos;)&#x7ED3;&#x675F;&#xFF0C;&#x82E5;&#x5B57;&#x7B26;&#x4E32;&#x4E3A;&#x7A7A;&#xFF0C;&#x6216;&#x957F;&#x5EA6;&#x4E3A;0&#xFF0C;&#x5219;&#x5957;&#x63A5;&#x5B57;&#x4E0E;&#x7F51;&#x7EDC;&#x63A5;&#x53E3;&#x4E4B;&#x95F4;&#x7684;&#x7ED1;&#x5B9A;&#x5C06;&#x88AB;&#x79FB;&#x9664;&#x3002;</p>
<h2 id="23---soreuseaddr">2.3 - SO_REUSEADDR</h2>
<p>&#x8BE5;&#x9009;&#x9879;&#x901A;&#x5E38;&#x7528;&#x4E8E;&#x670D;&#x52A1;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5FEB;&#x901F;&#x91CD;&#x542F;&#xFF0C;&#x800C;&#x975E;&#x540C;&#x65F6;&#x8FD0;&#x884C;&#x540C;&#x4E00;&#x672C;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x7684;&#x591A;&#x4E2A;&#x5B9E;&#x4F8B;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;&#x6B63;&#x5E38;&#x6267;&#x884C;&#x4E3B;&#x52A8;&#x5173;&#x95ED;&#x7684;TCP&#x7AEF;&#xFF0C;&#x5176;&#x5957;&#x63A5;&#x5B57;&#x72B6;&#x6001;&#x7684;&#x8FC1;&#x79FB;&#x987A;&#x5E8F;&#x4F9D;&#x6B21;&#x4E3A;&#xFF1A;FIN_WAIT1 -&gt; FIN_WAIT2 -&gt; TIME_WAIT&#xFF0C;TIME_WAIT&#x72B6;&#x6001;&#x5C06;&#x6301;&#x7EED;&#x6301;&#x7EED;2MSL (Maximum Segment Lifetime)&#x65F6;&#x95F4;&#xFF0C;&#x7531;/proc/sys/net/ipv4/tcp_fin_timeout&#x6216;net.ipv4.tcp_fin_timeout&#x6307;&#x5B9A;&#xFF0C;&#x5355;&#x4F4D;&#x4E3A;&#x79D2;&#xFF1B;&#x6267;&#x884C;&#x4E3B;&#x52A8;&#x5173;&#x95ED;&#x7684;&#x4E00;&#x7AEF;&#x4E3A;TCP&#x670D;&#x52A1;&#x7AEF;&#x65F6;&#xFF0C;&#x5728;TIME_WAIT&#x6301;&#x7EED;&#x7684;&#x65F6;&#x95F4;&#x5185;&#xFF0C;&#x82E5;&#x672A;&#x6307;&#x5B9A;SO_REUSEADDR&#x9009;&#x9879;&#xFF0C;&#x5219;&#x5BF9;&#x76F8;&#x540C;&#x7684;&#x672C;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x518D;&#x6B21;&#x8C03;&#x7528;bind(2)&#x5C06;&#x4EE5;EADDRINUSE&#x9519;&#x8BEF;&#x5931;&#x8D25;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;TCP&#xFF0C;&#x8BE5;&#x9009;&#x9879;&#x7684;&#x8BBE;&#x7F6E;&#x65B9;&#x5F0F;&#x4E3A;&#xFF1A;</p>
<pre><code class="lang-c"><span class="hljs-keyword">int</span> sfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);

<span class="hljs-keyword">int</span> optval = <span class="hljs-number">1</span>;
setsockopt(sfd, SOL_SOCKET, SO_REUSEADDR, &amp;optval, <span class="hljs-keyword">sizeof</span>(optval));

bind(sfd, (<span class="hljs-keyword">struct</span> sockaddr *) &amp;addr, addrlen);
</code></pre>
<p>&#x82E5;&#x9700;&#x4F7F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x5219;&#x6BCF;&#x4E00;&#x4E2A;&#x5957;&#x63A5;&#x5B57;&#xFF08;&#x5305;&#x62EC;&#x7B2C;1&#x4E2A;&#xFF09;&#x5728;&#x6267;&#x884C;bind(2)&#x524D;&#x90FD;&#x5FC5;&#x987B;&#x5F00;&#x542F;&#x8BE5;&#x9009;&#x9879;&#xFF0C;&#x4E14;&#x539F;&#x5957;&#x63A5;&#x5B57;&#x7684;&#x72B6;&#x6001;&#x4E0D;&#x80FD;&#x4E3A;LISTEN&#x3002;</p>
<h2 id="3-&#x7A0B;&#x5E8F;&#x9A8C;&#x8BC1;">3. &#x7A0B;&#x5E8F;&#x9A8C;&#x8BC1;</h2>
<p>&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x7248;&#x672C;&#xFF1A;CentOS Linux release 7.5.1804 (Core)</p>
<p>&#x5185;&#x6838;&#x7248;&#x672C;&#xFF1A;3.10.0-862.2.3.el7.x86_64</p>
<p>gcc&#x7248;&#x672C;&#xFF1A;gcc version 4.8.5 20150623 (Red Hat 4.8.5-28) (GCC)</p>
<p>glibc&#x7248;&#x672C;&#xFF1A;GNU C Library (GNU libc) stable release version 2.17, by Roland McGrath et al.</p>
<p>&#x670D;&#x52A1;&#x7AEF;IP&#xFF1A;eth0/22.99.22.111</p>
<p>&#x5BA2;&#x6237;&#x7AEF;IP&#xFF1A;eth0/22.99.22.101</p>
<blockquote>
<p>&#x670D;&#x52A1;&#x7AEF;&#x7A0B;&#x5E8F;&#xFF1A;reuse_tcp_server.c</p>
<p>&#x5FC5;&#x9009;&#x53C2;&#x6570;-i/--ip&#x4E0E;-p/-port&#x5206;&#x522B;&#x6307;&#x5B9A;&#x672C;&#x7AEF;ipv4&#x5730;&#x5740;&#x4E0E;&#x7AEF;&#x53E3;&#x53F7;</p>
<p>&#x53EF;&#x9009;&#x53C2;&#x6570;-D/--device&#x6307;&#x5B9A;&#x5957;&#x63A5;&#x5B57;&#x7ED1;&#x5B9A;&#x7684;&#x672C;&#x5730;&#x7F51;&#x7EDC;&#x63A5;&#x53E3;</p>
<p>&#x53EF;&#x9009;&#x53C2;&#x6570;-E/--exit&#x6307;&#x5B9A;&#x7236;&#x8FDB;&#x7A0B;&#x5728;&#x521B;&#x5EFA;&#x5B8C;&#x6BD5;&#x5B50;&#x8FDB;&#x7A0B;&#x4E4B;&#x540E;&#x9000;&#x51FA;&#x7684;&#x6807;&#x5FD7;</p>
<p>&#x53EF;&#x9009;&#x53C2;&#x6570;-A/--reuseaddr&#x4E0E;-P/--reuseport&#x5206;&#x522B;&#x6307;&#x5B9A;&#x5F00;&#x542F;SO_REUSEADDR&#x4E0E;SO_REUSEPORT&#x7684;&#x6807;&#x5FD7;</p>
</blockquote>
<pre><code class="lang-c"><span class="hljs-comment">/* reuse_tcp_server.c */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;getopt.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;net/if.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> LISTENQ 1024</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUF_SIZE 64</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SA struct sockaddr</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ERR_EXIT(msg, ...) \
    do { fprintf(stderr, msg, ##__VA_ARGS__); exit(EXIT_FAILURE); } while (0)</span>

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handle_request</span><span class="hljs-params">(<span class="hljs-keyword">int</span>)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set_reuse_port_addr</span><span class="hljs-params">(<span class="hljs-keyword">int</span>, <span class="hljs-keyword">int</span>, <span class="hljs-keyword">void</span> *)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">5</span>)
        ERR_EXIT(<span class="hljs-string">&quot;Usage:\n&quot;</span>
            <span class="hljs-string">&quot;options:\n&quot;</span>
            <span class="hljs-string">&quot; -i/--ip local ipv4 address\n&quot;</span>
            <span class="hljs-string">&quot; -p/-port local port number\n&quot;</span>
            <span class="hljs-string">&quot; [-D/--device] network device name\n&quot;</span>
            <span class="hljs-string">&quot; [-E/--exit] parent exit after fork\n&quot;</span>
            <span class="hljs-string">&quot; [-A/--reuseaddr] set the SO_REUSEADDR option\n&quot;</span>
            <span class="hljs-string">&quot; [-P/--reuseport] set the SO_REUSEPORT option\n&quot;</span>);

    <span class="hljs-keyword">int</span> lfd, cfd;
    <span class="hljs-keyword">int</span> reuseaddr = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> reuseport = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">int</span> parent_exit = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">char</span> *local_ip = <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">short</span> local_port = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">char</span> *dev = <span class="hljs-literal">NULL</span>;
    <span class="hljs-keyword">struct</span> sockaddr_in svaddr;
    <span class="hljs-keyword">socklen_t</span> svaddrlen;
    <span class="hljs-keyword">struct</span> sigaction sa;

    sigemptyset(&amp;sa.sa_mask);
    sa.sa_handler = SIG_IGN;
    <span class="hljs-keyword">if</span> (sigaction(SIGCHLD, &amp;sa, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;sigaction() failed: %s\n&quot;</span>, strerror(errno));

    <span class="hljs-keyword">for</span> ( ; ; ) {
        <span class="hljs-keyword">int</span> option_index = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span> *short_options = <span class="hljs-string">&quot;i:p:D:EAP&quot;</span>;
        <span class="hljs-keyword">static</span> <span class="hljs-keyword">struct</span> option long_options[] = {
            {<span class="hljs-string">&quot;ip&quot;</span>,            required_argument,    <span class="hljs-number">0</span>,  <span class="hljs-string">&apos;i&apos;</span> },
            {<span class="hljs-string">&quot;port&quot;</span>,        required_argument,    <span class="hljs-number">0</span>,  <span class="hljs-string">&apos;p&apos;</span> },
            {<span class="hljs-string">&quot;device&quot;</span>,        required_argument,    <span class="hljs-number">0</span>,  <span class="hljs-string">&apos;D&apos;</span> },
            {<span class="hljs-string">&quot;exit&quot;</span>,        no_argument,        <span class="hljs-number">0</span>,  <span class="hljs-string">&apos;E&apos;</span> },
            {<span class="hljs-string">&quot;reuseaddr&quot;</span>,    no_argument,        <span class="hljs-number">0</span>,  <span class="hljs-string">&apos;A&apos;</span> },
            {<span class="hljs-string">&quot;reuseport&quot;</span>,    no_argument,        <span class="hljs-number">0</span>,  <span class="hljs-string">&apos;P&apos;</span> },
            {<span class="hljs-number">0</span>,                <span class="hljs-number">0</span>,                    <span class="hljs-number">0</span>,   <span class="hljs-number">0</span>  }
        };

        <span class="hljs-keyword">int</span> c = getopt_long(argc, argv, short_options, long_options, &amp;option_index);
        <span class="hljs-keyword">if</span> (c == <span class="hljs-number">-1</span>)
            <span class="hljs-keyword">break</span>;

        <span class="hljs-keyword">switch</span> (c) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;i&apos;</span>:
            local_ip = optarg;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;p&apos;</span>:
            local_port = (<span class="hljs-keyword">short</span>)atoi(optarg);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;D&apos;</span>:
            dev = optarg;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;E&apos;</span>:
            parent_exit = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;A&apos;</span>:
            reuseaddr = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;P&apos;</span>:
            reuseport = <span class="hljs-number">1</span>;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;?&apos;</span>:
        <span class="hljs-keyword">default</span>:
            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
        }
    }

    <span class="hljs-keyword">if</span> (!local_ip)
        ERR_EXIT(<span class="hljs-string">&quot;invalid local ip address\n&quot;</span>);

    <span class="hljs-keyword">if</span> (!local_port)
        ERR_EXIT(<span class="hljs-string">&quot;invalid local port\n&quot;</span>);

    lfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (lfd == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;socket() failed: %s\n&quot;</span>, strerror(errno));

    <span class="hljs-keyword">if</span> (reuseaddr)
        set_reuse_port_addr(lfd, SO_REUSEADDR, &amp;reuseaddr);

    <span class="hljs-keyword">if</span> (reuseport)
        set_reuse_port_addr(lfd, SO_REUSEPORT, &amp;reuseport);

    <span class="hljs-keyword">if</span> (dev)
        set_reuse_port_addr(lfd, SO_BINDTODEVICE, dev);

    svaddrlen = <span class="hljs-keyword">sizeof</span>(svaddr);

    <span class="hljs-built_in">memset</span>(&amp;svaddr, <span class="hljs-number">0</span>, svaddrlen);
    svaddr.sin_family = AF_INET;
    svaddr.sin_port = htons(local_port);

    <span class="hljs-keyword">if</span> (inet_pton(AF_INET, local_ip, &amp;svaddr.sin_addr) == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;inet_pton() failed: %s\n&quot;</span>, strerror(errno));

    <span class="hljs-keyword">if</span> (bind(lfd, (SA *)&amp;svaddr, svaddrlen) == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;bind() failed: %s\n&quot;</span>, strerror(errno));

    <span class="hljs-keyword">if</span> (listen(lfd, LISTENQ) == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;listen() failed: %s\n&quot;</span>, strerror(errno));

    <span class="hljs-keyword">for</span> ( ; ; ) {
        cfd = accept(lfd, <span class="hljs-literal">NULL</span>, <span class="hljs-literal">NULL</span>);
        <span class="hljs-keyword">if</span> (cfd == <span class="hljs-number">-1</span>)
            ERR_EXIT(<span class="hljs-string">&quot;accept() failed: %s\n&quot;</span>, strerror(errno));

        <span class="hljs-keyword">switch</span> (fork()) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span>:
            perror(<span class="hljs-string">&quot;fork() failed&quot;</span>);
            close(cfd);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            close(lfd);
            handle_request(cfd);
            _exit(EXIT_SUCCESS);
        <span class="hljs-keyword">default</span>:
            <span class="hljs-keyword">if</span> (parent_exit)
                <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);

            close(cfd);
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">set_reuse_port_addr</span><span class="hljs-params">(<span class="hljs-keyword">int</span> s, <span class="hljs-keyword">int</span> optname, <span class="hljs-keyword">void</span> *optval)</span>
</span>{
    <span class="hljs-keyword">int</span> len;
    <span class="hljs-keyword">if</span> (optname == SO_BINDTODEVICE)
        len = (<span class="hljs-built_in">strlen</span>(optval) &gt; IF_NAMESIZE) ? IF_NAMESIZE : <span class="hljs-built_in">strlen</span>(optval);
    <span class="hljs-keyword">else</span>
        len = <span class="hljs-keyword">sizeof</span>(<span class="hljs-keyword">int</span>);

    <span class="hljs-keyword">if</span> (setsockopt(s, SOL_SOCKET, optname, optval, len) == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;setsockopt(%d) failed: %s\n&quot;</span>, optname, strerror(errno));
}

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">handle_request</span><span class="hljs-params">(<span class="hljs-keyword">int</span> cfd)</span>
</span>{
    <span class="hljs-keyword">char</span> sendbuf[BUF_SIZE] = {<span class="hljs-number">0</span>};
    <span class="hljs-keyword">char</span> recvbuf[BUF_SIZE] = {<span class="hljs-number">0</span>};
    <span class="hljs-keyword">int</span> n;

    <span class="hljs-built_in">snprintf</span>(sendbuf, BUF_SIZE, <span class="hljs-string">&quot;server: %d\n&quot;</span>, getppid());
    <span class="hljs-keyword">if</span> (write(cfd, sendbuf, <span class="hljs-built_in">strlen</span>(sendbuf)) != <span class="hljs-built_in">strlen</span>(sendbuf))
        ERR_EXIT(<span class="hljs-string">&quot;write() to client failed: %s\n&quot;</span>, strerror(errno));

    <span class="hljs-keyword">while</span> ((n = read(cfd, recvbuf, BUF_SIZE)) &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span> &amp;&amp; recvbuf[<span class="hljs-number">0</span>] == <span class="hljs-string">&apos;W&apos;</span>) {
            <span class="hljs-keyword">if</span> (write(cfd, <span class="hljs-string">&quot;W&quot;</span>, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)
                ERR_EXIT(<span class="hljs-string">&quot;sending end of message failed: %s\n&quot;</span>, strerror(errno));

            <span class="hljs-keyword">break</span>;
        }
    }

    shutdown(cfd, SHUT_RDWR);
    close(cfd);
}
</code></pre>
<blockquote>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x7A0B;&#x5E8F;&#xFF1A;tcp_client.c</p>
<p>&#x5FC5;&#x9009;&#x53C2;&#x6570;-i&#x4E0E;-p&#x5206;&#x522B;&#x6307;&#x5B9A;&#x670D;&#x52A1;&#x7AEF;&#x7684;ipv4&#x5730;&#x5740;&#x4E0E;&#x7AEF;&#x53E3;&#x53F7;</p>
<p>&#x53EF;&#x9009;&#x53C2;&#x6570;-n&#x6307;&#x5B9A;&#x5411;&#x670D;&#x52A1;&#x7AEF;&#x53D1;&#x8D77;&#x8FDE;&#x63A5;&#x7684;&#x6570;&#x91CF;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;1</p>
</blockquote>
<pre><code class="lang-c"><span class="hljs-comment">/* tcp_client.c */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdio.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/types.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/socket.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;arpa/inet.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;string.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;signal.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;errno.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> SA struct sockaddr</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> BUF_SIZE 64</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> ERR_EXIT(msg, ...) \
    do { fprintf(stderr, msg, ##__VA_ARGS__); exit(EXIT_FAILURE); } while (0)</span>

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">connect_to_server</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *, <span class="hljs-keyword">short</span>)</span></span>;
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exchange_info</span><span class="hljs-params">(<span class="hljs-keyword">int</span>)</span></span>;

<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> *argv[])</span>
</span>{
    <span class="hljs-keyword">if</span> (argc &lt; <span class="hljs-number">5</span>)
        ERR_EXIT(<span class="hljs-string">&quot;Usage: %s -i &lt;ip&gt; -p &lt;port&gt; -n &lt;count&gt;\n&quot;</span>, argv[<span class="hljs-number">0</span>]);

    <span class="hljs-keyword">int</span> cfd, i, c, nr_children;
    <span class="hljs-keyword">struct</span> sockaddr_in svaddr;
    <span class="hljs-keyword">socklen_t</span> svaddrlen;
    <span class="hljs-keyword">char</span> *svip;
    <span class="hljs-keyword">short</span> svport = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">struct</span> sigaction sa;

    sigemptyset(&amp;sa.sa_mask);
    sa.sa_handler = SIG_IGN;
    <span class="hljs-keyword">if</span> (sigaction(SIGCHLD, &amp;sa, <span class="hljs-literal">NULL</span>) == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;sigaction() failed: %s\n&quot;</span>, strerror(errno));

    nr_children = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">while</span> ((c = getopt(argc, argv, <span class="hljs-string">&quot;i:p:n:&quot;</span>)) != <span class="hljs-number">-1</span>) {
        <span class="hljs-keyword">switch</span> (c) {
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;i&apos;</span>:
            svip = optarg;
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;p&apos;</span>:
            svport = (<span class="hljs-keyword">in_port_t</span>)atoi(optarg);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;n&apos;</span>:
            nr_children = atoi(optarg);
            <span class="hljs-keyword">break</span>;
        <span class="hljs-keyword">case</span> <span class="hljs-string">&apos;?&apos;</span>:
        <span class="hljs-keyword">default</span>:
            <span class="hljs-built_in">exit</span>(EXIT_FAILURE);
        }
    }

    <span class="hljs-keyword">if</span> (!svip)
        ERR_EXIT(<span class="hljs-string">&quot;invalid server ip\n&quot;</span>);

    <span class="hljs-keyword">if</span> (!svport)
        ERR_EXIT(<span class="hljs-string">&quot;invalid server port\n&quot;</span>);

    <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; nr_children; i++) {
        <span class="hljs-keyword">switch</span> (fork()) {
        <span class="hljs-keyword">case</span> <span class="hljs-number">-1</span>:
            ERR_EXIT(<span class="hljs-string">&quot;fork() failed:%s\n&quot;</span>, strerror(errno));
        <span class="hljs-keyword">case</span> <span class="hljs-number">0</span>:
            connect_to_server(svip, svport);
            _exit(EXIT_SUCCESS);
        <span class="hljs-keyword">default</span>:
            close(cfd);
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-keyword">for</span> ( ; ; )
        sleep(<span class="hljs-number">1</span>);

    <span class="hljs-built_in">exit</span>(EXIT_SUCCESS);
}

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">connect_to_server</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *svip, <span class="hljs-keyword">short</span> svport)</span>
</span>{
    <span class="hljs-keyword">int</span> cfd;
    <span class="hljs-keyword">struct</span> sockaddr_in svaddr;
    <span class="hljs-keyword">socklen_t</span> svaddrlen;

    cfd = socket(AF_INET, SOCK_STREAM, <span class="hljs-number">0</span>);
    <span class="hljs-keyword">if</span> (cfd == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;socket() failed: %s\n&quot;</span>, strerror(errno));

    <span class="hljs-built_in">memset</span>(&amp;svaddr, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(svaddr));
    svaddr.sin_family = AF_INET;
    svaddr.sin_port = htons(svport);

    <span class="hljs-keyword">if</span> (inet_pton(AF_INET, svip, &amp;svaddr.sin_addr) == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;inet_pton() failed: %s\n&quot;</span> ,strerror(errno));

    svaddrlen = <span class="hljs-keyword">sizeof</span>(svaddr);

    <span class="hljs-keyword">if</span> (connect(cfd, (SA *)&amp;svaddr, svaddrlen) == <span class="hljs-number">-1</span>)
        ERR_EXIT(<span class="hljs-string">&quot;connect() failed: %s\n&quot;</span>, strerror(errno));

    exchange_info(cfd);
    shutdown(cfd, SHUT_RDWR);
    close(cfd);
}

<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">exchange_info</span><span class="hljs-params">(<span class="hljs-keyword">int</span> cfd)</span>
</span>{
    <span class="hljs-keyword">char</span> recvbuf[BUF_SIZE] = {<span class="hljs-number">0</span>};
    <span class="hljs-keyword">int</span> n;

    <span class="hljs-keyword">while</span> ((n = read(cfd, recvbuf, BUF_SIZE)) &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">if</span> (n == <span class="hljs-number">1</span> &amp;&amp; recvbuf[<span class="hljs-number">0</span>] == <span class="hljs-string">&apos;W&apos;</span>)
            <span class="hljs-keyword">return</span>;

        <span class="hljs-keyword">if</span> (write(STDOUT_FILENO, recvbuf, n) != n)
            ERR_EXIT(<span class="hljs-string">&quot;write() to stdout failed: %s\n&quot;</span>, strerror(errno));

        <span class="hljs-keyword">if</span> (write(cfd, <span class="hljs-string">&quot;W&quot;</span>, <span class="hljs-number">1</span>) != <span class="hljs-number">1</span>)
            ERR_EXIT(<span class="hljs-string">&quot;sending end of message failed: %s\n&quot;</span>, strerror(errno));
    }
}
</code></pre>
<blockquote>
<p>&#x8FDE;&#x63A5;&#x5EFA;&#x7ACB;&#x540E;&#xFF0C;&#x670D;&#x52A1;&#x7AEF;&#x5411;&#x5BA2;&#x6237;&#x7AEF;&#x8F93;&#x51FA;&#x672C;&#x7AEF;&#x521B;&#x5EFA;&#x76D1;&#x542C;&#x5957;&#x63A5;&#x5B57;&#x7684;&#x8FDB;&#x7A0B;PID&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5C06;&#x8BE5;&#x4FE1;&#x606F;&#x6253;&#x5370;&#x81F3;&#x6807;&#x51C6;&#x8F93;&#x51FA;&#xFF0C;&#x5E76;&#x5411;&#x670D;&#x52A1;&#x7AEF;&#x53D1;&#x9001;&#x5B57;&#x7B26;&apos;W&apos;&#x4EE5;&#x5BA3;&#x544A;&#x7ED3;&#x675F;&#x8FDE;&#x63A5;&#xFF1B;&#x670D;&#x52A1;&#x7AEF;&#x63A5;&#x6536;&#x5230;&#x8BE5;&#x5B57;&#x7B26;&#x540E;&#x7ACB;&#x5373;&#x6267;&#x884C;&#x4E3B;&#x52A8;&#x5173;&#x95ED;&#x3002;</p>
</blockquote>
<p>&#x5206;&#x522B;&#x7F16;&#x8BD1;</p>
<pre><code class="lang-c"><span class="hljs-meta"># gcc reuse_tcp_server.c -o reuse_tcp_server</span>
</code></pre>
<pre><code class="lang-c"><span class="hljs-meta"># gcc tcp_client.c -o tcp_client</span>
</code></pre>
<h2 id="&#x793A;&#x4F8B;1---tcp&#x8FDE;&#x63A5;&#x7684;&#x6B63;&#x5E38;&#x5173;&#x95ED;">&#x793A;&#x4F8B;1 - TCP&#x8FDE;&#x63A5;&#x7684;&#x6B63;&#x5E38;&#x5173;&#x95ED;</h2>
<p>&#x6267;&#x884C;&#x670D;&#x52A1;&#x7AEF;&#x7A0B;&#x5E8F;&#xFF0C;&#x901A;&#x8FC7;&#x4EE5;&#x4E0B;&#x811A;&#x672C;&#x6253;&#x5370;tcp&#x72B6;&#x6001;&#xFF0C;&#x5E76;&#x542F;&#x52A8;tcpdump&#x6293;&#x5305;</p>
<pre><code class="lang-c"><span class="hljs-meta"># sysctl net.ipv4.tcp_fin_timeout</span>
net.ipv4.tcp_fin_timeout = <span class="hljs-number">60</span>
</code></pre>
<pre><code class="lang-c"><span class="hljs-meta"># tcpdump -i eth0 -nn -S host 22.99.22.111 and host 22.99.22.101 and tcp</span>
</code></pre>
<pre><code class="lang-c"><span class="hljs-meta"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 &amp;</span>
[<span class="hljs-number">1</span>] <span class="hljs-number">71624</span>
</code></pre>
<pre><code class="lang-c"><span class="hljs-meta"># vi trace_tcp_state.sh</span>

<span class="hljs-meta">#! /bin/bash</span>

<span class="hljs-keyword">while</span> <span class="hljs-literal">true</span>; <span class="hljs-keyword">do</span>
    ss -atn state fin-wait<span class="hljs-number">-1</span> state fin-wait<span class="hljs-number">-2</span> state time-wait state close-wait state last-ack | grep :<span class="hljs-number">8888</span> | <span class="hljs-keyword">while</span> read line; <span class="hljs-keyword">do</span>
        [[ ${line} != <span class="hljs-string">&quot;&quot;</span> ]] &amp;&amp; { echo <span class="hljs-string">&quot;$(date +%T.%N)  $line&quot;</span>; } || <span class="hljs-keyword">break</span>
    done
done
</code></pre>
<pre><code class="lang-c"><span class="hljs-meta"># ./trace_tcp_state.sh &gt; /tmp/tcp.log &amp;</span>
[<span class="hljs-number">2</span>] <span class="hljs-number">71659</span>
</code></pre>
<p>&#x6267;&#x884C;&#x5BA2;&#x6237;&#x7AEF;&#x7A0B;&#x5E8F;</p>
<pre><code class="lang-c"><span class="hljs-meta"># ./tcp_client -i 22.99.22.111 -p 8888 &amp;</span>
[<span class="hljs-number">1</span>] <span class="hljs-number">1947</span>
<span class="hljs-meta"># server: 71624</span>
</code></pre>
<p>&#x670D;&#x52A1;&#x7AEF;&#x6293;&#x5305;&#x7ED3;&#x679C;&#x663E;&#x793A;&#x4E24;&#x7AEF;&#x5206;&#x522B;&#x4EA4;&#x6362;&#x4E86;FIN&#x4E0E;ACK&#xFF0C;&#x5B8C;&#x6210;4&#x6B21;&#x6325;&#x624B;</p>
<pre><code class="lang-bash">05:49:00.360589 IP 22.99.22.101.52090 &gt; 22.99.22.111.8888: Flags [S], seq 3903021351, win 29200, options [mss 1460,sackOK,TS val 47936384 ecr 0,nop,wscale 7], length 0
05:49:00.360701 IP 22.99.22.111.8888 &gt; 22.99.22.101.52090: Flags [S.], seq 2388910389, ack 3903021352, win 28960, options [mss 1460,sackOK,TS val 47984822 ecr 47936384,nop,wscale 7], length 0
05:49:00.360920 IP 22.99.22.101.52090 &gt; 22.99.22.111.8888: Flags [.], ack 2388910390, win 229, options [nop,nop,TS val 47936384 ecr 47984822], length 0
05:49:00.362624 IP 22.99.22.111.8888 &gt; 22.99.22.101.52090: Flags [P.], seq 2388910390:2388910404, ack 3903021352, win 227, options [nop,nop,TS val 47984824 ecr 47936384], length 14
05:49:00.362993 IP 22.99.22.101.52090 &gt; 22.99.22.111.8888: Flags [.], ack 2388910404, win 229, options [nop,nop,TS val 47936386 ecr 47984824], length 0
05:49:00.363005 IP 22.99.22.101.52090 &gt; 22.99.22.111.8888: Flags [P.], seq 3903021352:3903021353, ack 2388910404, win 229, options [nop,nop,TS val 47936386 ecr 47984824], length 1
05:49:00.363287 IP 22.99.22.111.8888 &gt; 22.99.22.101.52090: Flags [.], ack 3903021353, win 227, options [nop,nop,TS val 47984825 ecr 47936386], length 0
05:49:00.363466 IP 22.99.22.111.8888 &gt; 22.99.22.101.52090: Flags [P.], seq 2388910404:2388910405, ack 3903021353, win 227, options [nop,nop,TS val 47984825 ecr 47936386], length 1
05:49:00.363600 IP 22.99.22.111.8888 &gt; 22.99.22.101.52090: Flags [F.], seq 2388910405, ack 3903021353, win 227, options [nop,nop,TS val 47984825 ecr 47936386], length 0
05:49:00.363805 IP 22.99.22.101.52090 &gt; 22.99.22.111.8888: Flags [F.], seq 3903021353, ack 2388910405, win 229, options [nop,nop,TS val 47936387 ecr 47984825], length 0
05:49:00.363813 IP 22.99.22.111.8888 &gt; 22.99.22.101.52090: Flags [.], ack 3903021354, win 227, options [nop,nop,TS val 47984825 ecr 47936387], length 0
05:49:00.364039 IP 22.99.22.101.52090 &gt; 22.99.22.111.8888: Flags [.], ack 2388910406, win 229, options [nop,nop,TS val 47936387 ecr 47984825], length 0
</code></pre>
<p>&#x670D;&#x52A1;&#x7AEF;&#x811A;&#x672C;&#x65E5;&#x5FD7;/tmp/tcp.log&#x505C;&#x6B62;&#x5199;&#x5165;&#x540E;&#xFF0C;&#x5BF9;&#x6BD4;&#x7B2C;&#x4E00;&#x6761;&#x4E0E;&#x6700;&#x540E;&#x4E00;&#x6761;TIME-WAIT&#x7684;&#x65F6;&#x95F4;&#x6233;&#xFF0C;&#x76F8;&#x9694;&#x7EA6;60&#x79D2;</p>
<pre><code class="lang-bash">05:49:00.367070710  TIME-WAIT  0      0      22.99.22.111:8888               22.99.22.101:52090
05:50:00.529636558  TIME-WAIT  0      0      22.99.22.111:8888               22.99.22.101:52090
</code></pre>
<h2 id="&#x793A;&#x4F8B;2---soreuseport&#x9009;&#x9879;">&#x793A;&#x4F8B;2 - SO_REUSEPORT&#x9009;&#x9879;</h2>
<p>&#x670D;&#x52A1;&#x7AEF;&#x4EE5;-P&#x6307;&#x5B9A;&#x5F00;&#x542F;SO_REUSEADDR&#x9009;&#x9879;&#xFF0C;&#x5728;ipv4&#x901A;&#x914D;&#x5730;&#x5740;(0.0.0.0)&#x4E0A;&#x8FD0;&#x884C;2&#x4E2A;&#x5B9E;&#x4F8B;</p>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -P &amp;</span>
[1] 68554
<span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -P &amp;</span>
[2] 68556
<span class="hljs-comment"># ss -atn | grep 8888</span>
LISTEN     0      128          *:8888                     *:*
LISTEN     0      128          *:8888                     *:*
</code></pre>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x6307;&#x5B9A;-n&#x9009;&#x9879;&#xFF0C;&#x5411;&#x670D;&#x52A1;&#x7AEF;&#x53D1;&#x9001;20&#x4E2A;&#x8FDE;&#x63A5;&#x8BF7;&#x6C42;</p>
<pre><code class="lang-bash"><span class="hljs-comment"># ./tcp_client -i 22.99.22.111 -p 8888 -n 20</span>
server: 68554
server: 68554
server: 68556
server: 68554
server: 68554
server: 68554
server: 68556
server: 68554
server: 68556
server: 68556
server: 68556
server: 68556
server: 68556
server: 68556
server: 68556
server: 68556
server: 68556
server: 68554
server: 68554
server: 68556
^C
<span class="hljs-comment"># ss -atn | grep 8888</span>
</code></pre>
<p>&#x4E24;&#x4E2A;&#x670D;&#x52A1;&#x7AEF;&#x5B9E;&#x4F8B;68554&#x4E0E;68556&#x5206;&#x522B;&#x5904;&#x7406;&#x4E86;8&#x4E2A;&#x4E0E;12&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x6B63;&#x5E38;&#x5173;&#x95ED;&#x3002;</p>
<h2 id="&#x793A;&#x4F8B;3---sobindtodevice&#x9009;&#x9879;">&#x793A;&#x4F8B;3 - SO_BINDTODEVICE&#x9009;&#x9879;</h2>
<p>&#x670D;&#x52A1;&#x7AEF;&#x4EE5;-D&#x6307;&#x5B9A;&#x5F00;&#x542F;SO_BINDTODEVICE&#x9009;&#x9879;&#xFF0C;&#x5206;&#x522B;&#x5C06;ipv4&#x901A;&#x914D;&#x5730;&#x5740;&#x5C1D;&#x8BD5;&#x7ED1;&#x5B9A;&#x81F3;&#x76F8;&#x540C;&#x4E0E;&#x4E0D;&#x540C;&#x7684;&#x7F51;&#x7EDC;&#x63A5;&#x53E3;</p>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -D lo &amp;</span>
[1] 69025
<span class="hljs-comment"># ./reuse_tcp_server -i 22.99.22.111 -p 8888 -D lo &amp;</span>
[2] 69032
<span class="hljs-comment"># bind() failed: Address already in use</span>

[2]+  Exit 1                  ./reuse_tcp_server -i 22.99.22.111 -p 8888 -D lo
<span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -D eth0 &amp;</span>
[2] 69055
<span class="hljs-comment"># ss -atn | grep 8888</span>
LISTEN     0      128     *%eth0:8888                     *:*
LISTEN     0      128       *%lo:8888                     *:*
</code></pre>
<p>&#x8FD0;&#x884C;&#x5BA2;&#x6237;&#x7AEF;</p>
<pre><code class="lang-bash"><span class="hljs-comment"># ./tcp_client -i 22.99.22.111 -p 8888</span>
server: 69055
</code></pre>
<h2 id="&#x793A;&#x4F8B;4---soreuseaddr&#x9009;&#x9879;">&#x793A;&#x4F8B;4 - SO_REUSEADDR&#x9009;&#x9879;</h2>
<p>&#x5148;&#x540E;&#x4E24;&#x6B21;&#x8FD0;&#x884C;&#x670D;&#x52A1;&#x7AEF;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x4E0D;&#x5F00;&#x542F;SO_REUSEADDR&#x9009;&#x9879;&#xFF0C;&#x7236;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B50;&#x8FDB;&#x7A0B;&#x540E;&#x9000;&#x51FA;&#xFF1B;&#x7B2C;&#x4E8C;&#x6B21;&#x5F00;&#x542F;SO_REUSEADDR&#x9009;&#x9879;</p>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -E &amp;</span>
[1] 71163
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># ./tcp_client -i 22.99.22.111 -p 8888</span>
server: 71163
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -A &amp;</span>
[2] 71176
[1]   Done                    ./reuse_tcp_server -i 0.0.0.0 -p 8888 -E
<span class="hljs-comment"># bind() failed: Address already in use</span>

[2]+  Exit 1                  ./reuse_tcp_server -i 0.0.0.0 -p 8888 -A
<span class="hljs-comment">#</span>
<span class="hljs-comment">#</span>
[root@localhost backup]<span class="hljs-comment"># ss -atn | grep 8888</span>
TIME-WAIT  0      0      22.99.22.111:8888               22.99.22.101:52138
</code></pre>
<p>&#x539F;&#x5957;&#x63A5;&#x5B57;&#x672A;&#x5F00;&#x542F;SO_REUSEADDR&#x9009;&#x9879;&#xFF0C;&#x65B0;&#x5957;&#x63A5;&#x5B57;&#x65E0;&#x6CD5;&#x590D;&#x7528;&#x539F;ip&#x4E0E;&#x7AEF;&#x53E3;</p>
<p>&#x5148;&#x540E;&#x4E24;&#x6B21;&#x8FD0;&#x884C;&#x670D;&#x52A1;&#x7AEF;&#x5E76;&#x5F00;&#x542F;SO_REUSEADDR&#x9009;&#x9879;&#xFF0C;&#x4F46;&#x539F;&#x5957;&#x63A5;&#x5B57;&#x7684;&#x7236;&#x8FDB;&#x7A0B;&#x4E0D;&#x9000;&#x51FA;</p>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -A &amp;</span>
[1] 69642
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># ./tcp_client -i 22.99.22.111 -p 8888</span>
server: 69642
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -A &amp;</span>
[2] 69650
<span class="hljs-comment"># bind() failed: Address already in use</span>

[2]+  Exit 1                  ./reuse_tcp_server -i 0.0.0.0 -p 8888 -A
<span class="hljs-comment"># ss -atn | grep 8888</span>
LISTEN     0      128          *:8888                     *:*
TIME-WAIT  0      0      22.99.22.111:8888               22.99.22.101:52134
</code></pre>
<p>&#x867D;&#x7136;&#x4E24;&#x6B21;&#x8FD0;&#x884C;&#x90FD;&#x5F00;&#x542F;&#x4E86;SO_REUSEADDR&#x9009;&#x9879;&#xFF0C;&#x4F46;&#x7531;&#x4E8E;&#x7528;&#x4E8E;&#x5904;&#x7406;&#x76D1;&#x542C;&#x5957;&#x63A5;&#x5B57;&#x7684;&#x7236;&#x8FDB;&#x7A0B;&#x672A;&#x9000;&#x51FA;&#x800C;&#x4ECD;&#x5904;&#x4E8E;LISTEN&#x72B6;&#x6001;&#xFF0C;&#x56E0;&#x6B64;&#x518D;&#x6B21;&#x8C03;&#x7528;bind(2)&#x5931;&#x8D25;&#x3002;</p>
<p>&#x518D;&#x6B21;&#x8FD0;&#x884C;&#x670D;&#x52A1;&#x7AEF;&#x5E76;&#x5F00;&#x542F;SO_REUSEADDR&#x9009;&#x9879;&#xFF0C;&#x4E14;&#x4EE4;&#x7236;&#x8FDB;&#x7A0B;&#x521B;&#x5EFA;&#x5B50;&#x8FDB;&#x7A0B;&#x540E;&#x7ACB;&#x5373;&#x9000;&#x51FA;</p>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -A -E &amp;</span>
[1] 69924
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># ./tcp_client -i 22.99.22.111 -p 8888</span>
server: 69924
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 -A &amp;</span>
[2] 69933
[1]   Done                    ./reuse_tcp_server -i 0.0.0.0 -p 8888 -A -E
<span class="hljs-comment"># ss -atn | grep 8888</span>
LISTEN     0      128          *:8888                     *:*
TIME-WAIT  0      0      22.99.22.111:8888               22.99.22.101:52136
</code></pre>
<p>&#x7236;&#x8FDB;&#x7A0B;&#x7ACB;&#x5373;&#x88AB;&#x518D;&#x6B21;&#x8FD0;&#x884C;&#x7684;&#x5B9E;&#x4F8B;69933&#x66FF;&#x6362;&#xFF0C;&#x5B50;&#x8FDB;&#x7A0B;&#x7EE7;&#x7EED;&#x7EF4;&#x6301;TIME_WAIT&#x72B6;&#x6001;&#x3002;</p>
<h2 id="&#x793A;&#x4F8B;5---&#x901A;&#x914D;&#x5730;&#x5740;">&#x793A;&#x4F8B;5 - &#x901A;&#x914D;&#x5730;&#x5740;</h2>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 &amp;</span>
[1] 70155
<span class="hljs-comment"># ./reuse_tcp_server -i 22.99.22.111 -p 8888 &amp;</span>
[2] 70165
<span class="hljs-comment"># bind() failed: Address already in use</span>

[2]+  Exit 1                  ./reuse_tcp_server -i 22.99.22.111 -p 8888
<span class="hljs-comment"># ps aux | grep tcp_server | grep -v grep | awk &apos;{print $2}&apos; | xargs kill -9</span>
[1]+  Killed                  ./reuse_tcp_server -i 0.0.0.0 -p 8888
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># ./reuse_tcp_server -i 22.99.22.111 -p 8888 &amp;</span>
[1] 70249
<span class="hljs-comment"># ./reuse_tcp_server -i 0.0.0.0 -p 8888 &amp;</span>
[2] 70253
<span class="hljs-comment"># bind() failed: Address already in use</span>

[2]+  Exit 1                  ./reuse_tcp_server -i 0.0.0.0 -p 8888
</code></pre>
<pre><code class="lang-bash"><span class="hljs-comment"># ps aux | grep tcp_server | grep -v grep | awk &apos;{print $2}&apos; | xargs kill -9</span>
[1]+  Killed                  ./reuse_tcp_server -i 22.99.22.111 -p 8888
<span class="hljs-comment">#</span>
<span class="hljs-comment"># ./reuse_tcp_server -i 22.99.22.111 -p 8888 &amp;</span>
[1] 70290
<span class="hljs-comment"># ./reuse_tcp_server -i 127.0.0.1 -p 8888 &amp;</span>
[2] 70299
<span class="hljs-comment"># ss -atn | grep 8888</span>
LISTEN     0      128    127.0.0.1:8888                     *:*
LISTEN     0      128    22.99.22.111:8888                     *:*
</code></pre>
<p>&#x82E5;&#x672A;&#x6307;&#x5B9A;SO_REUSEPORT/SO_BINDTODEVICE/SO_REUSEADDR&#xFF0C;&#x5219;&#x901A;&#x914D;&#x5730;&#x5740;&#x4E0E;&#x5177;&#x4F53;&#x5730;&#x5740;&#x4E92;&#x65A5;&#x800C;&#x4E0D;&#x5141;&#x8BB8;&#x7ED1;&#x5B9A;&#xFF1B;&#x591A;&#x4E2A;&#x5177;&#x4F53;&#x4E14;&#x4E0D;&#x76F8;&#x540C;&#x7684;ipv4&#x5730;&#x5740;&#x5141;&#x8BB8;&#x7ED1;&#x5B9A;&#x81F3;&#x76F8;&#x540C;&#x7684;&#x7AEF;&#x53E3;&#x3002;</p>
<h2 id="4-&#x5185;&#x6838;&#x89D2;&#x5EA6;">4. &#x5185;&#x6838;&#x89D2;&#x5EA6;</h2>
<p>bind(2)&#x8C03;&#x7528;&#x65F6;&#x9700;&#x8981;&#x9A8C;&#x8BC1;&#x672C;&#x7AEF;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x662F;&#x5426;&#x53EF;&#x4EE5;&#x590D;&#x7528;&#xFF0C;&#x7528;&#x4E8E;&#x9A8C;&#x8BC1;&#x7684;&#x51FD;&#x6570;&#x4E3A;inet_csk_get_port()&#x4E0E;inet_csk_bind_conflict()&#xFF0C;&#x8C03;&#x7528;&#x8DEF;&#x5F84;&#x4E3A;sys_bind() -&gt; inet_bind() -&gt; inet_csk_get_port() -&gt; inet_csk_bind_conflict()</p>
<p>include/net/inet_hashtables.h&#x5934;&#x6587;&#x4EF6;&#x7684;&#x6CE8;&#x91CA;&#x4E2D;&#x5BF9;&#x5957;&#x63A5;&#x5B57;&#x5730;&#x5740;&#x590D;&#x7528;&#x7684;&#x57FA;&#x672C;&#x89C4;&#x5219;&#x8FDB;&#x884C;&#x4E86;&#x7B80;&#x5355;&#x8BF4;&#x660E;&#xFF1A;</p>
<pre><code class="lang-bash">/* include/net/inet_hashtables.h */

 47 /* There are a few simple rules, <span class="hljs-built_in">which</span> allow <span class="hljs-keyword">for</span> <span class="hljs-built_in">local</span> port reuse by
 48  * an application.  In essence:
 49  *
 50  *  1) Sockets bound to different interfaces may share a <span class="hljs-built_in">local</span> port.
 51  *     Failing that, goto <span class="hljs-built_in">test</span> 2.
 52  *  2) If all sockets have sk-&gt;sk_reuse <span class="hljs-built_in">set</span>, and none of them are <span class="hljs-keyword">in</span>
 53  *     TCP_LISTEN state, the port may be shared.
 54  *     Failing that, goto <span class="hljs-built_in">test</span> 3.
 55  *  3) If all sockets are bound to a specific inet_sk(sk)-&gt;rcv_saddr <span class="hljs-built_in">local</span>
 56  *     address, and none of them are the same, the port may be
 57  *     shared.
 58  *     Failing this, the port cannot be shared.
 59  *
         ...
 77  */
</code></pre>
<h2 id="5-&#x53C2;&#x8003;">5. &#x53C2;&#x8003;</h2>
<p>&#x300A;The Linux Programming Interface&#x300B; Chapter 61</p>
<p>&#x300A;UNIX Network Programming Volume 1, Third Edition&#x300B;Chapter 7</p>
<p>socket(7)</p>
<p><em><a href="https://lwn.net/Articles/542629/" target="_blank">https://lwn.net/Articles/542629/</a></em></p>
<p>&#xA9; &#x8457;&#x4F5C;&#x6743;&#x5F52;&#x4F5C;&#x8005;&#x6240;&#x6709;</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="ssh-key-copy.html" class="navigation navigation-prev " aria-label="Previous page: SSH免密登录">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../Other/" class="navigation navigation-next " aria-label="Next page: Other">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Linux TCP套接字地址复用","date":"2021-12-06T10:22:32.000Z","tags":["linux","TCP"],"categories":"linux","description":"Linux TCP套接字地址复用。","level":"1.5.4","depth":2,"next":{"title":"Other","level":"1.6","depth":1,"path":"Other/README.md","ref":"Other/README.md","articles":[{"title":"郭德纲家书","level":"1.6.1","depth":2,"path":"Other/GuoHomeLetter.md","ref":"Other/GuoHomeLetter.md","articles":[]},{"title":"毒鸡汤","level":"1.6.2","depth":2,"path":"Other/ChickenSoup.md","ref":"Other/ChickenSoup.md","articles":[]},{"title":"天道·悟","level":"1.6.3","depth":2,"path":"Other/Tiandao-Wu.md","ref":"Other/Tiandao-Wu.md","articles":[]},{"title":"实用小工具","level":"1.6.4","depth":2,"path":"Other/tools-collection.md","ref":"Other/tools-collection.md","articles":[]},{"title":"图片","level":"1.6.5","depth":2,"path":"Other/MyPicture.md","ref":"Other/MyPicture.md","articles":[]}]},"previous":{"title":"SSH免密登录","level":"1.5.3","depth":2,"path":"Linux/ssh-key-copy.md","ref":"Linux/ssh-key-copy.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":["livereload"],"pluginsConfig":{"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"Linux/tcpsock-reuseport.md","mtime":"2024-06-25T03:39:03.199Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2024-06-25T08:45:00.198Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

